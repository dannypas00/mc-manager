version: '3'
services:
  db:
    container_name: mcm-db
    image: mariadb:latest
    ports:
      - "${MARIADB_PORT:-3306}:${MARIADB_PORT:-3306}"
    env_file:
      - .env
    volumes:
      - mysql:/var/lib/mysql/
    command:
      - mariadbd
      - --port=${MARIADB_PORT:-3306}

  redis:
    container_name: mcm-redis
    image: redis:latest

  test:
    container_name: mcm-test
    build:
      dockerfile: .docker/local/Dockerfile
      context: .
    user: 1000:1000
    volumes:
      - ./:/var/www
    working_dir: /var/www
    command:
      - sh
      - -c
      - |
          composer install -q;

  php:
    container_name: mcm-php
    build:
      dockerfile: .docker/local/Dockerfile
      context: .
    user: 1000:1000
    depends_on:
      - db
      - redis
    volumes:
      - ./:/var/www
      - ./tests/output:/opt/phpstorm-coverage

  horizon:
    container_name: mcm-horizon
    image: dannypas00/laravel-fpm:8.2
    depends_on:
      - db
      - redis
    command:
      - php
      - artisan
      - horizon
    volumes:
      - ./:/var/www

  schedule:
    container_name: mcm-schedule
    image: dannypas00/laravel-fpm:8.2
    depends_on:
      - db
      - redis
    command:
      - php
      - artisan
      - schedule:work
    volumes:
      - ./:/var/www

  websockets:
    container_name: mcm-websockets
    image: dannypas00/laravel-fpm:8.2
    depends_on:
      - db
      - redis
    command:
      - php
      - artisan
      - websockets:serve
    ports:
      - "6001:6001"
    volumes:
      - ./:/var/www

  nginx:
    container_name: mcm-nginx
    image: nginx:latest
    depends_on:
      - php
    ports:
      - "80:80"
    volumes:
      - .docker/local/nginx-includes:/etc/nginx/conf.d
      - ./:/var/www

  minecraft:
    container_name: mcm-minecraft
    image: openjdk:22-slim
    ports:
      - "25565:25565"
      - "25575:25575"
    user: 1000:1000
    volumes:
      - .docker/local/minecraft:/minecraft
    working_dir: /minecraft
    restart: on-failure
    command:
      - java
      - -Xmx1G
      - -Xms1G
      - -jar
      - server.jar
      - nogui

  ftp:
    container_name: mcm-ftp
    image: delfer/alpine-ftp-server:latest
    ports:
      - "21:21"
      - "21000-21010:21000-21010"
    environment:
      - "USERS=mcm-test|mcm-test|/minecraft|1000"
    volumes:
      - .docker/local/minecraft:/minecraft

  sftp:
    container_name: mcm-sftp
    image: atmoz/sftp:alpine
    ports:
      - "23:22"
    environment:
      - "SFTP_USERS=mcm-test:mcm-test:::/minecraft"
    volumes:
      - .docker/local/minecraft:/minecraft

  ssh:
    container_name: mcm-ssh
    image: linuxserver/openssh-server
    ports:
      - "2222:2222"
    environment:
      - "USER_NAME=mcm-test"
      - "PUBLIC_KEY=ecdsa-sha2-nistp521 AAAAE2VjZHNhLXNoYTItbmlzdHA1MjEAAAAIbmlzdHA1MjEAAACFBAF0JviXigZIXknkj7em8jfNM8nK9YnnP6p0ou1kftNH9n5/O5cbfHa0fYD20qGxk/G4Eo8au+mDM8CumG6cf7Lu5wGMHCLggXykoHzYXAH0I9ZYpaOKRkX2cW0W36Cbgy/fYKOio6aE8zUQeNq+q3vMBLHhUcICtnjQBq5r1iA5iAzSog== root@60e6f5524e95"
    volumes:
      - .docker/local/minecraft:/minecraft

volumes:
    mysql:
